default_platform(:android)

platform :android do
  desc "Deploy (build .aab e envia para a Play Store)"
  lane :deploy do
    gradle(
      task: "bundle",
      build_type: "Release"
    )

    # Verifica se o app existe
    begin
      UI.message("Verificando se o app existe na Google Play...")
      supply(
        json_key: ENV["ANDROID_JSON_KEY_PATH"],
        package_name: "br.com.delivery.chefinhos",
        validate_only: true # Apenas verifica se o app existe
      )
    rescue => e
      UI.error("App n√£o encontrado. Criando o app na Play Store...")
      create_app()
    end

    # Realiza o deploy
    supply(
      aab: "app/build/outputs/bundle/release/app-release.aab",
      track: "production",
      json_key: ENV["ANDROID_JSON_KEY_PATH"], 
      package_name: "br.com.delivery.chefinhos", 
      skip_upload_images: true, 
      skip_upload_screenshots: true,
      skip_upload_changelogs: false, 
      skip_upload_metadata: true 
    )
  end

  desc "Cria o app do zero na Play Store"
  lane :create_app do
    gradle(
      task: "bundle",
      build_type: "Release"
    )

    UI.message("Criando o app na Google Play...")
    supply(
      aab: "app/build/outputs/bundle/release/app-release.aab",
      track: "production",
      json_key: ENV["ANDROID_JSON_KEY_PATH"],
      package_name: "br.com.delivery.chefinhos",
      skip_upload_images: true, 
      skip_upload_screenshots: true, 
      skip_upload_changelogs: true, 
      skip_upload_metadata: true
    )
  end
end
